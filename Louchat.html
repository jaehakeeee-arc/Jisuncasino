<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>익명 게시판 (Supabase)</title>
  <style>
    body {
      margin: 0;
      padding: 12px;
      background: #f4f4f4;
      font-family: sans-serif;
      font-size: 18px;
    }
    h1 {
      font-size: 24px;
      text-align: center;
      margin-bottom: 16px;
    }
    #adminBtn, #submitBtn {
      font-size: 18px;
      padding: 14px;
      width: 100%;
      margin-bottom: 10px;
      border-radius: 8px;
      border: none;
      color: white;
    }
    #adminBtn { background: #007bff; }
    #submitBtn { background: #28a745; }
    #adminBadge {
      font-size: 16px;
      display: none;
      text-align: center;
      margin-bottom: 16px;
      color: red;
    }
    textarea {
      width: 100%;
      min-height: 100px;
      font-size: 16px;
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .comment {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 14px;
      margin: 12px 0;
      font-size: 16px;
      position: relative;
    }
    .menu {
      position: absolute;
      right: 12px;
      top: 12px;
      font-size: 20px;
      cursor: pointer;
    }
    small {
      display: block;
      margin-top: 8px;
      font-size: 14px;
      color: #666;
    }
    /* 모달 스타일 */
    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      width: 80%;
      max-width: 300px;
      text-align: center;
    }
    .modal-content input {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      font-size: 16px;
    }
    .modal-content button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>익명 채팅 게시판</h1>
  <button id="adminBtn">관리자 로그인</button>
  <span id="adminBadge">관리자 모드</span>
  <textarea id="msg" placeholder="댓글 입력"></textarea>
  <button id="submitBtn">등록</button>
  <div id="list"></div>

  <!-- 관리자 로그인 모달 -->
  <div id="adminModal" class="modal">
    <div class="modal-content">
      <h3>관리자 키 입력</h3>
      <input type="password" id="adminKeyInput" placeholder="키 입력">
      <button id="adminLoginConfirm">로그인</button>
      <button id="adminLoginCancel">취소</button>
    </div>
  </div>

<script>
const SUPABASE_URL = "https://jaztoerkyizeieaskbtz.supabase.co"; // 프로젝트 URL
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImphenRvZXJreWl6ZWllYXNrYnR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxMzM5NDksImV4cCI6MjA3OTcwOTk0OX0.aEnIKh4OxlfOroAIhMsnQNwj65FQ4fYa8-G49UTw2q4"; // anon public key
const headers = {
  "apikey": SUPABASE_KEY,
  "Authorization": "Bearer " + SUPABASE_KEY,
  "Content-Type": "application/json"
};

let isAdmin = false;
const ADMIN_KEY = "123456789";

// 모달 관련 요소
const adminModal = document.getElementById("adminModal");
const adminKeyInput = document.getElementById("adminKeyInput");
const adminLoginConfirm = document.getElementById("adminLoginConfirm");
const adminLoginCancel = document.getElementById("adminLoginCancel");

// 관리자 버튼 클릭 → 모달 열기
document.getElementById("adminBtn").addEventListener("click", () => {
  if (!isAdmin) {
    adminModal.style.display = "flex";
    adminKeyInput.value = "";
  } else {
    // 로그아웃
    isAdmin = false;
    document.getElementById("adminBadge").style.display = "none";
    document.getElementById("adminBtn").textContent = "관리자 로그인";
    loadComments();
  }
});

// 모달 로그인 확인
adminLoginConfirm.addEventListener("click", () => {
  const key = adminKeyInput.value.trim();
  if (key === ADMIN_KEY) {
    isAdmin = true;
    document.getElementById("adminBadge").style.display = "block";
    document.getElementById("adminBtn").textContent = "관리자 로그아웃";
    adminModal.style.display = "none";
    loadComments();
  } else {
    alert("잘못된 키입니다.");
  }
});

// 모달 취소
adminLoginCancel.addEventListener("click", () => {
  adminModal.style.display = "none";
});

// 댓글 등록 버튼
document.getElementById("submitBtn").addEventListener("click", postComment);

// 댓글 등록
async function postComment() {
  const text = document.getElementById("msg").value.trim();
  if (!text) return alert("내용을 입력하세요");
  await fetch(`${SUPABASE_URL}/rest/v1/comments`, {
    method: "POST",
    headers,
    body: JSON.stringify({ text })
  });
  document.getElementById("msg").value = "";
  loadComments();
}

// 댓글 불러오기
async function loadComments() {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/comments?order=created_at.desc`, { headers });
  const data = await res.json();
  const list = document.getElementById("list");
  list.innerHTML = "";
  data.forEach(c => {
    const div = document.createElement("div");
    div.className = "comment";
    div.innerHTML = `<div>${c.text}</div><small>${c.created_at}</small>`;
    
    if (isAdmin) {
      const menu = document.createElement("div");
      menu.className = "menu";
      menu.innerHTML = "⋮";
      menu.onclick = async () => {
        const action = prompt("edit 또는 delete 입력");
        if (action === "edit") {
          const newText = prompt("새 내용 입력", c.text);
          if (newText) {
            await fetch(`${SUPABASE_URL}/rest/v1/comments?id=eq.${c.id}`, {
              method: "PATCH",
              headers,
              body: JSON.stringify({ text: newText })
            });
            loadComments();
          }
        } else if (action === "delete") {
          await fetch(`${SUPABASE_URL}/rest/v1/comments?id=eq.${c.id}`, {
            method: "DELETE",
            headers
          });
          loadComments();
        }
      };
      div.appendChild(menu);
    }
    list.appendChild(div);
  });
}

loadComments();
</script>
</body>
</html>
